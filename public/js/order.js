var form=document.forms.orderForm,inputPrice=$("#price-data"),product=null,orderId=null,productId=window.location.pathname.split("/").pop(),currency=$("#input[name=price]").data("currency");let countryCode=$("input[name=price]").data("country"),specialPriceIsActive=!1;$("input:hidden[name=special_price]")&&(specialPriceIsActive=$("input:hidden[name=special_price]").val()>0);let promoCodeIsActive=!1;$("input[name=discount]").length>0&&(promoCodeIsActive=!0),$.ajax({type:"get",url:`/api/order/${productId}`}).done(e=>{$(".inc-desc-button").prop("disabled",!1),product=e.product});var balkansCountries=["BA","RS","ME","MK","HR"],discountedCountries=["AE"],nonEuropeCountries=["AE","IN","SA","CA","US","AL","BA","RS","ME","MK"],noFreeShippingCountries=balkansCountries.concat(discountedCountries);function inc(){console.log(form.quantity.value),form.quantity.value=Number(form.quantity.value)+1,inputPrice.value=$("input[name='price']").data("price")*Number(form.quantity.value)}function dec(){1!==Number(form.quantity.value)&&(form.quantity.value=Number(form.quantity.value)-1,inputPrice.value=$("input[name='price']").data("price")*Number(form.quantity.value))}$("#inc-button").click(function(){var e=Number(form.quantity.value),n=$("input[name=price]").data("currency"),t=$("input[name=price]").data("shipping"),r=$("input[name='price']").data("price");let i=$("input:hidden[name=old_price]").val();if(noFreeShippingCountries.includes(countryCode)||(r-=t),e>=6)return;form.quantity.value=e+1;let a="",o=Number(r)*Number(form.quantity.value);if(specialPriceIsActive&&e>0?(inputPrice.value=String(Number(r)*(Number(form.quantity.value)-1)+Number($("input:hidden[name=special_price]").val()))+n,o=Number(r)*(Number(form.quantity.value)-1)+Number($("input:hidden[name=special_price]").val())):inputPrice.value=String(Number(r)*Number(form.quantity.value))+n,noFreeShippingCountries.includes(countryCode))a=String(o.toFixed(2));else{a=String((o+t).toFixed(2)),$(".quantity-discount").show()}if($("input:hidden[name=priceToBeDiscounted]").val(a),promoCodeIsActive&&""!==$("input[name=discount]").val()&&(a=countDiscount(Number($("input[name=discount]").val()))),a.indexOf(".")>-1&&(a=a.slice(0,a.indexOf(".")+3)),$(".old-price h2 span").length>0){let e=i*Number(form.quantity.value),t=String(e.toFixed(2));"AE"===countryCode?$(".old-price h2 span").html(n+" "+t):$(".old-price h2 span").html(t+" "+n)}"AE"===countryCode?$("#price-data h2 span").html(n+" "+a):$("#price-data h2 span").html(a+" "+n)}),$("#dec-button").click(function(){var e=Number(form.quantity.value)-1,n=$("input[name=price]").data("currency"),t=$("input[name=price]").data("shipping"),r=$("input[name='price']").data("price");let i=$("input:hidden[name=old_price]").val();if(noFreeShippingCountries.includes(countryCode)||(r-=t),1!==Number(form.quantity.value)){form.quantity.value=Number(form.quantity.value)-1;let a="",o=Number(r)*Number(form.quantity.value);if(specialPriceIsActive?2==e?(inputPrice.value=String(Number(r)+Number($("input:hidden[name=special_price]").val()))+n,o=Number(r)+Number($("input:hidden[name=special_price]").val())):e>2&&(inputPrice.value=String(Number(r)*Number(form.quantity.value))+n,o=Number(r)*(Number(form.quantity.value)-1)+Number($("input:hidden[name=special_price]").val())):inputPrice.value=String(Number(r)*Number(form.quantity.value))+n,noFreeShippingCountries.includes(countryCode))a=String(o.toFixed(2));else{a=String((o+t).toFixed(2)),1==form.quantity.value&&$(".quantity-discount").hide()}if($("input:hidden[name=priceToBeDiscounted]").val(a),promoCodeIsActive&&""!==$("input[name=discount]").val()&&(a=countDiscount(Number($("input[name=discount]").val()))),a.indexOf(".")>-1&&(a=a.slice(0,a.indexOf(".")+3)),$(".old-price h2 span").length>0){let e=i*Number(form.quantity.value),t=String(e.toFixed(2));"AE"===countryCode?$(".old-price h2 span").html(n+" "+t):$(".old-price h2 span").html(t+" "+n)}"AE"===countryCode?$("#price-data h2 span").html(n+" "+a):$("#price-data h2 span").html(a+" "+n)}});var delay=function(){var e=0;return function(n,t){clearTimeout(e),e=setTimeout(n,t)}}();function countDiscount(e){let n=$("input:hidden[name=priceToBeDiscounted]").val(),t=n-e/100*n;return $("#promoCodeSuccess").show(),$("#price-data span").html($("input[name=price]").data("currency")+" "+String(t.toFixed(2))),String(t.toFixed(2))}function formInputHasError(e,n){switch(e){case"firstnameAndLastname":case"lastname":if(n.length<3)return!0;break;case"phone":if(nonEuropeCountries.includes(countryCode)){if(n.length<6)return!0;break}if(n.length<9)return!0;break;case"email":if(n.length<5||!/^.+@.+\..+$/.test(n))return!0;break;case"address":case"city":case"country":case"zip":if(n.length<3)return!0;break;case"note":if(n.length>500)return!0;break;case"paymentType":if(void 0===n)return console.log("undefined"),!0}}function resetErrors(){$(".form-error").hide()}function toggleSpinner(e=!0){e?$(".cover-spin").show():$(".cover-spin").hide()}$("input[name=promoCode]").on("keydown",function(){delay(function(){toggleSpinner(),$.ajax({type:"POST",url:"/api/validatePromoCode",data:{promoCode:$("input[name=promoCode]").val()}}).done(e=>{if("promoCodeError"===e.status){$("#promoCodeError").show(),$("input[name=discount]").val();let e=$("input[name=price]").data("currency");inputPrice.value=String($("input[name='price']").data("price")*Number(form.quantity.value))+e,toggleSpinner(!1)}else $("#promoCodeError").hide(),$("input[name=discount]").val(e.discount),$("#promoCodeSuccess").show(),countDiscount(e.discount);setTimeout(function(){$(".cover-spin").hide()},2e3)}).fail(e=>{alert(e.message)})},1500)}),$("input").on("blur",e=>{let n=e.currentTarget.value,t=e.currentTarget.name,r=!1;(r=formInputHasError(t,n))?$(`p#${t}.form-error`).show():$(`p#${t}.form-error`).hide()}),$("#back_to_2").click(e=>{$("#order_step_1").show(),$("#order_step_2").hide()}),$(".btn-order").click(e=>{e.preventDefault(),resetErrors(),toggleSpinner();let n=$("input[name=price]").val(),t=n.match(/\d+/)[0],r=Number(t)+Number($("input[name=price]").data("shipping")),i=$("input[name=price]").data("currency"),a={firstnameAndLastname:$("input[name=firstnameAndLastname]").val(),phone:$("input[name=phone]").val(),email:$("input[name=email]").val(),address:$("input[name=address]").val(),zip:void 0!==$("input[name=zip]").val()?$("input[name=zip]").val():"000",note:$("textarea[name=note]").val(),quantity:$("input[name=quantity]").val(),price:r+$("input[name=price]").data("currency"),productPriceId:$("input[name=price]").data("price-id"),lang:$("input[name=price]").data("lang"),productId:productId,sessionId:$("input[name=price]").data("session-id"),paymentType:$("[name=paymentType]").val(),promoCode:$("input[name=promoCode]").val()},o=$("input[name=price]").data("country");a.city="AE"===o||"IN"===o?$("select[name=city]").val():$("input[name=city]").val();var u=!1;Object.keys(a).forEach((e,n)=>{formInputHasError(e,a[e])?(u=!0,$("input[name="+e+"]").focus(),$(`p#${e}.form-error`).show()):$(`p#${e}.form-error`).hide()}),u?toggleSpinner(!1):$.ajax({type:"POST",url:"/api/order",data:{order:a}}).done(e=>{if(!0===e.status)if("type"in e&&"corvus"===e.type){let n=e.data,t='<form action="'+e.url+'" method="POST" style="display: none">';Object.keys(n).map(e=>{t+='<input type="hidden" name="'+e+'" value="'+n[e]+'">'}),t+="</form>",$(t).appendTo("body").submit()}else fbq("track","Purchase",{currency:i,value:(Number(n.replace(/[^0-9\.-]+/g,""))-Number($("input[name=price]").data("shipping")))*Number(a.quantity)}),"external"===e.redirect?window.open(e.url,"_blank"):window.location.href=e.url;else"promoCodeError"===e.status?$("#promoCodeError").show():($("#error").show(),$("#error").html(e.error));toggleSpinner(!1)}).fail(e=>{alert(e.message)})});var paymentNotificationModal=new tingle.modal({footer:!0,stickyFooter:!1,closeMethods:["overlay","button","escape"],closeLabel:"Close",onClose:function(){window.location.href=document.querySelector(".returnPage").innerHTML}}),url=window.location.search;url&&(paymentNotificationModal.setContent(document.querySelector(".paymentMessage").innerHTML),url.match("canceled").length>0&&paymentNotificationModal.open());
